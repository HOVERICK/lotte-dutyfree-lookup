<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>워크숍 참여자 조회</title>

<!-- CSV/XLSX 파서 -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR","Malgun Gothic",Arial,sans-serif;margin:0;background:#fafafa;color:#111}
  .wrap{max-width:720px;margin:0 auto;padding:28px}
  h1{font-size:22px;margin:0 0 16px}
  .bar{display:flex;gap:8px}
  input[type="text"]{flex:1;padding:14px 16px;border:1px solid #ddd;border-radius:12px;font-size:16px;outline:none;background:#fff}
  button{padding:14px 18px;border:1px solid #ddd;background:#111;color:#fff;border-radius:12px;cursor:pointer;font-size:15px}
  .result-empty{color:#888;text-align:center;margin-top:24px}
  .card{background:#fff;border:1px solid #eee;border-radius:14px;padding:16px;margin-top:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .row{display:grid;grid-template-columns:120px 1fr;gap:8px;padding:8px 0;border-top:1px dashed #eee}
  .row:first-child{border-top:0}
  .label{color:#666}
  .value{font-weight:600}
  .count{color:#666;font-size:13px;margin-top:12px}
  /* 숨김용 */
  .hidden{display:none}

  /* 수동 매핑 모달 */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{max-width:520px;width:100%;background:#fff;border-radius:14px;border:1px solid #eee;padding:18px}
  .modal h2{margin:0 0 12px;font-size:18px}
  .modal .rowmap{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin:10px 0}
  select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;background:#fff}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
  .ghost{background:#fff;color:#111}
  .top-actions{display:flex;gap:8px;justify-content:flex-end;margin:8px 0 0}
  .gear{appearance:none;border:1px solid #ddd;background:#fff;border-radius:12px;padding:12px 14px;cursor:pointer}
</style>
</head>
<body>
  <div class="wrap">
    <h1>워크숍 참여자 조회</h1>

    <div class="bar">
      <input id="q" type="text" placeholder="이름을 입력하세요 (예: 홍길동)" enterkeyhint="search" autofocus>
      <button id="btn">검색</button>
      <button id="gear" class="gear hidden" title="수동 매핑(헤더 지정)">⚙️</button>
    </div>

    <div id="count" class="count hidden"></div>
    <div id="results"></div>
    <div id="empty" class="result-empty hidden">검색 결과가 없습니다. 철자(공백 포함)를 확인해 주세요.</div>
  </div>

  <!-- 수동 매핑 모달 -->
  <div id="modal" class="modal">
    <div class="box">
      <h2>열 매핑 설정</h2>
      <div id="mapRows"></div>
      <div class="actions">
        <button id="cancel" class="ghost">취소</button>
        <button id="saveMap">저장</button>
      </div>
    </div>
  </div>

<script>
/* ========= 설정 ========= */
const CSV_URL  = "data/participants.csv";
const XLSX_URL = "data/participants.xlsx";

/* ========= 별칭(유사 표기 흡수) ========= */
const aliases = {
  "성명": ["성명","이름","성명(한글)","신청자명","참여자명","성 명"],
  "소속부문": ["소속부문","소속","소속(부문)","부문","소속 본부","소속부서(대)","소속부문명","본부","부 문"],
  "부서명": ["부서명","부서","소속부서","팀명","소속(팀)","소속부서(소)","팀","부 서"],
  "차수": ["차수","회차","차수(신청)","신청차수","차 수"]
};
const required = ["차수","성명","소속부문","부서명"];

/* ========= 상태 ========= */
let rows = [];          // 정규화 후 [{차수,성명,소속부문,부서명}, ...]
let headerRaw = [];     // 원본 헤더
let rawTable = [];      // 원본 2차원 배열 (헤더포함)
let colMap = {};        // {"성명":"이름", ...} 형태
let manualNeeded = false;

/* ========= 유틸 ========= */
const $ = sel => document.querySelector(sel);
const norm = s => (s ?? "").toString().trim();
const normKey = s => norm(s).replace(/\s+/g,"").toLowerCase();

function scoreHeader(cells){
  // 해당 행이 헤더 후보로서 몇 개의 별칭을 맞추는지 점수화
  let score = 0;
  const set = cells.map(c => normKey(c));
  for (const want of required){
    const list = aliases[want];
    const hit = set.some(v => list.some(a => v.includes(normKey(a))));
    if (hit) score++;
  }
  return score;
}

function pickHeaderIndex(matrix){
  // 가장 점수가 높은 행(최소 2개 이상 매칭되는 행)을 헤더로 선택
  let best = {idx:0, score:-1};
  for (let i=0;i<Math.min(matrix.length, 30);i++){
    const row = matrix[i] || [];
    // 공백만 많은 경우 제외
    const nonEmpty = row.filter(v => norm(v).length>0).length;
    if (nonEmpty < 2) continue;
    const sc = scoreHeader(row);
    if (sc > best.score) best = {idx:i, score:sc};
  }
  return best.score >= 2 ? best.idx : 0; // 못 찾으면 0행
}

function buildAutoMap(header){
  const map = {};
  for (const want of required){
    const cand = header.find(h => aliases[want].some(a => normKey(h).includes(normKey(a))));
    map[want] = cand || null;
  }
  return map;
}

function applyMap(header, data, map){
  const idx = {};
  required.forEach(k => {
    const src = map[k];
    idx[k] = src ? header.indexOf(src) : -1;
  });
  const out = [];
  for (const row of data){
    const rec = {};
    required.forEach(k=>{
      const i = idx[k];
      rec[k] = (i>=0 && i<row.length) ? norm(row[i]) : "";
    });
    if (rec["성명"]) out.push(rec);
  }
  return out;
}

/* ========= 렌더 ========= */
function render(items){
  const results = $("#results");
  const count = $("#count");
  const empty = $("#empty");
  results.innerHTML = "";
  if (!items.length){
    count.classList.add("hidden");
    empty.classList.remove("hidden");
    return;
  }
  empty.classList.add("hidden");
  count.textContent = `${items.length}건이 검색되었습니다.`;
  count.classList.remove("hidden");

  const frag = document.createDocumentFragment();
  items.forEach(item=>{
    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="row"><div class="label">차수</div><div class="value">${item["차수"]||""}</div></div>
      <div class="row"><div class="label">성명</div><div class="value">${item["성명"]||""}</div></div>
      <div class="row"><div class="label">소속부문</div><div class="value">${item["소속부문"]||""}</div></div>
      <div class="row"><div class="label">부서명</div><div class="value">${item["부서명"]||""}</div></div>`;
    frag.appendChild(el);
  });
  results.appendChild(frag);
}

function search(){
  const term = norm($("#q").value);
  const key = term.replace(/\s+/g,"").toLowerCase();
  const items = rows.filter(r => (r["성명"]||"").replace(/\s+/g,"").toLowerCase().includes(key));
  render(items);
}

/* ========= 데이터 로딩 (CSV 우선 → XLSX) ========= */
async function fetchText(url){
  const res = await fetch(url, {cache:"no-store"});
  if (!res.ok) throw new Error("not found");
  return await res.text();
}

async function fetchArrayBuffer(url){
  const res = await fetch(url, {cache:"no-store"});
  if (!res.ok) throw new Error("not found");
  return await res.arrayBuffer();
}

async function loadCSV(){
  const text = await fetchText(CSV_URL);
  const parsed = Papa.parse(text, {header:false, skipEmptyLines:true});
  return parsed.data;
}

async function loadXLSX(){
  const buf = await fetchArrayBuffer(XLSX_URL);
  const wb = XLSX.read(buf, {type:"array"});
  const ws = wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
}

async function loadData(){
  rawTable = [];
  try{
    rawTable = await loadCSV();
  }catch(e1){
    try{ rawTable = await loadXLSX(); }
    catch(e2){ rawTable = []; }
  }
  if (!rawTable.length){
    rows = [];
    $("#gear").classList.add("hidden");
    return;
  }

  // 헤더 후보 선택
  const headerIdx = pickHeaderIndex(rawTable);
  const header = (rawTable[headerIdx] || []).map(v => norm(v));
  const data = rawTable.slice(headerIdx+1);

  headerRaw = header.slice();
  colMap = buildAutoMap(header);

  // 매핑 실패(필수 중 1개 이상 null)이면 기어버튼 노출해 수동 매핑 유도
  manualNeeded = required.some(k => !colMap[k]);
  $("#gear").classList.toggle("hidden", !manualNeeded);

  rows = applyMap(header, data, colMap);
}

/* ========= 수동 매핑 UI ========= */
function openMapModal(){
  const modal = $("#modal");
  const mapRows = $("#mapRows");
  modal.style.display = "flex";
  mapRows.innerHTML = "";

  required.forEach(want=>{
    const wrap = document.createElement("div");
    wrap.className = "rowmap";
    const label = document.createElement("div");
    label.textContent = want;
    const sel = document.createElement("select");
    const optNone = document.createElement("option");
    optNone.value = ""; optNone.textContent = "(선택 없음)";
    sel.appendChild(optNone);

    headerRaw.forEach(h=>{
      const op = document.createElement("option");
      op.value = h; op.textContent = h;
      if (colMap[want] === h) op.selected = true;
      sel.appendChild(op);
    });
    sel.addEventListener("change", ()=>{ colMap[want] = sel.value || null; });
    wrap.appendChild(label); wrap.appendChild(sel);
    mapRows.appendChild(wrap);
  });
}
function closeMapModal(){ $("#modal").style.display = "none"; }

/* ========= 이벤트 ========= */
$("#btn").addEventListener("click", search);
$("#q").addEventListener("keydown", e=>{ if(e.key==="Enter") search(); });
$("#gear").addEventListener("click", openMapModal);
$("#cancel").addEventListener("click", closeMapModal);
$("#saveMap").addEventListener("click", ()=>{
  // 수동 매핑 반영하여 재적용
  const headerIdx = pickHeaderIndex(rawTable);
  const header = (rawTable[headerIdx] || []).map(v => norm(v));
  const data = rawTable.slice(headerIdx+1);
  rows = applyMap(header, data, colMap);
  closeMapModal();
  search(); // 현재 검색어로 갱신
});

/* ========= 초기화 ========= */
(async function init(){
  await loadData();
  // URL 파라미터로 자동 검색
  const params = new URLSearchParams(location.search);
  const preset = params.get("name");
  if (preset){ $("#q").value = preset; search(); }
})();
</script>
</body>
</html>
